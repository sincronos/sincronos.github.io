<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>Acerto Fiscal - Integração | </title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Integração Acerto FiscalPela camada de banco de dadosO processo de homologação na camada de banco de dados se dá pela elaboração das chamadasstored procedures (Procedimentos armazenados), também conhe">
<meta name="keywords" content="fiscal">
<meta property="og:type" content="article">
<meta property="og:title" content="Acerto Fiscal - Integração">
<meta property="og:url" content="http://sincronos.github.io/2021/03/31/Acerto/index.html">
<meta property="og:site_name">
<meta property="og:description" content="Integração Acerto FiscalPela camada de banco de dadosO processo de homologação na camada de banco de dados se dá pela elaboração das chamadasstored procedures (Procedimentos armazenados), também conhe">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2021-03-31T22:41:13.695Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Acerto Fiscal - Integração">
<meta name="twitter:description" content="Integração Acerto FiscalPela camada de banco de dadosO processo de homologação na camada de banco de dados se dá pela elaboração das chamadasstored procedures (Procedimentos armazenados), também conhe">
  
    <link rel="alternate" href="/atom.xml" title type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo"></a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://sincronos.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="integracao-acerto-fiscal-Acerto" class="article article-type-integracao-acerto-fiscal" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/31/Acerto/" class="article-date">
  <time datetime="2021-03-31T22:38:14.000Z" itemprop="datePublished">2021-03-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Acerto Fiscal - Integração
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Integracao-Acerto-Fiscal"><a href="#Integracao-Acerto-Fiscal" class="headerlink" title="Integração Acerto Fiscal"></a>Integração Acerto Fiscal</h1><h2 id="Pela-camada-de-banco-de-dados"><a href="#Pela-camada-de-banco-de-dados" class="headerlink" title="Pela camada de banco de dados"></a>Pela camada de banco de dados</h2><p>O processo de homologação na camada de banco de dados se dá pela elaboração das chamadas<br>stored procedures (Procedimentos armazenados), também conhecidas apenas por procedures. As<br>procedures são um conjunto de coordenadas procedurais escritas em SQL para manipular,<br>extrair ou armazenar dados em um banco de dados.</p>
<p>Como cada banco possui uma distribuição específica de tabelas de acordo com o software usado,<br>fica a cargo da Software House desenvolver a procedure seguindo a sintaxe do banco de dados e<br>conhecimento tácito do modelo de negócio aplicada à camada de dados.</p>
<p>Corretor Fiscal ™<br>O corretor fiscal é o programa desktop implantado no cliente responsável por executar as<br>procedures e fazer a comunicação do Acerto Fiscal com o banco de dados local do cliente. O<br>Corretor Fiscal geralmente fica instalado no servidor do cliente, ou em uma das máquinas da<br>rede, com acesso ao banco de dados.</p>
<p>Enviando dados para o acerto - <strong>CORRETORFISCAL_PRODUTOS</strong></p>
<p>Para enviar dados para o acerto o Corretor Fiscal irá procurar no banco do cliente por uma<br>procedure chamada CORRETORFISCAL_PRODUTOS que ficará encarregada de devolver dados<br>básicos dos produtos cadastrados.<br>A procedure receberá alguns parâmetros vindos do corretor fiscal e por sua vez também enviará<br>dados.</p>
<h3 id="Parametros-de-entrada"><a href="#Parametros-de-entrada" class="headerlink" title="Parâmetros de entrada"></a>Parâmetros de entrada</h3><p>O corretor enviará alguns dados ao chamar essa procedure, são eles:</p>
<p><strong>IDCLIENTE</strong> - O ID de cadastro do cliente no Acerto Fiscal. Tipo: VARCHAR(20)</p>
<p><strong>QTDEREGISTROS</strong> - Usada de forma interna pelo corretor para divisão de carga de envio.Tipo: INTEGER</p>
<p><strong>SKIPREGISTROS</strong> - Usada de forma interna pelo corretor para definir intervalos de execução.Tipo: INTEGER</p>
<p><strong>TODOS</strong> - Sinaliza se a procedure deve executar enviar TODOS os dados presentes no banco<br>ou apenas os que ainda não foram corrigidos. Tipo: CHAR(1)</p>
<h3 id="O-que-a-procedure-deve-fazer"><a href="#O-que-a-procedure-deve-fazer" class="headerlink" title="O que a procedure deve fazer ?"></a>O que a procedure deve fazer ?</h3><p>Quando receber o parâmetro de entrada TODOS como valor T a procedure deve enviar TODOS os<br>produtos presentes no banco do cliente. Quando a procedure receber o parâmetro de entrada<br>TODOS com valor diferente de T a mesma deve enviar apenas os produtos que ainda não foram<br>corrigidos.</p>
<p>Fica a cargo da Software House a criação de um campo para a sinalização se o produto foi<br>corrigido ou não pelo Corretor Fiscal. No caso da Tetra Soluções o campo a ser usado é o<br>FLAGTRIBUT.</p>
<h3 id="Exemplo-procedure-CORRETORFISCAL-PRODUTOS"><a href="#Exemplo-procedure-CORRETORFISCAL-PRODUTOS" class="headerlink" title="Exemplo procedure CORRETORFISCAL_PRODUTOS:"></a>Exemplo procedure CORRETORFISCAL_PRODUTOS:</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">ALTER</span> <span class="keyword">PROCEDURE</span> dbo.CORRETORFISCAL_PRODUTOS (@IDCLIENTE <span class="built_in">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">@QTDEREGISTROS <span class="built_in">INTEGER</span>,@SKIPREGISTROS <span class="built_in">INTEGER</span>,@TODOS <span class="built_in">CHAR</span>(<span class="number">1</span>) = <span class="string">'F'</span>)</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">IF</span> @TODOS = <span class="string">'T'</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">SELECT</span> <span class="keyword">MAX</span>(e.CODIGO) <span class="keyword">AS</span> CODIGOINTERNO,<span class="keyword">MAX</span>(e.NOME) <span class="keyword">AS</span> DESCRICAO, <span class="keyword">MAX</span>(e1.EAN) <span class="keyword">AS</span> EAN,<span class="keyword">MAX</span>(e.CODNCM) <span class="keyword">AS</span> CODIGONCM, <span class="keyword">MAX</span>(e.CODCEST) <span class="keyword">AS</span> CODIGOCEST,</span><br><span class="line">  <span class="keyword">MAX</span>(p.SAIDA) <span class="keyword">AS</span> CSTPISSAIDA, <span class="keyword">MAX</span>(p.ALIQPIS) <span class="keyword">AS</span> ALIQPISSAIDA, <span class="keyword">MAX</span>(p.SAIDA) <span class="keyword">AS</span> CSTCOFINSSAIDA, <span class="keyword">MAX</span>(p.ALIQCOFINS) <span class="keyword">AS</span> ALIQCOFINSSAIDA,</span><br><span class="line">  <span class="keyword">MAX</span>(<span class="keyword">CASE</span></span><br><span class="line">  <span class="keyword">WHEN</span> e.ICMS_SAI = <span class="string">'T'</span> <span class="keyword">AND</span> (a.REDUCAOBASECALCULO <span class="keyword">IS</span> <span class="literal">NULL</span> <span class="keyword">OR</span> a.REDUCAOBASECALCULO &lt;= <span class="number">0</span>) <span class="keyword">THEN</span> <span class="keyword">RIGHT</span>( <span class="string">'0'</span> + <span class="keyword">convert</span>(<span class="built_in">varchar</span>(<span class="number">2</span>), <span class="string">'0'</span>), <span class="number">2</span> )</span><br><span class="line">  <span class="keyword">WHEN</span> e.ICMS_SAI = <span class="string">'T'</span> <span class="keyword">AND</span> a.REDUCAOBASECALCULO &gt; <span class="number">0</span> <span class="keyword">THEN</span> <span class="keyword">RIGHT</span>( <span class="string">'0'</span> + <span class="keyword">convert</span>(<span class="built_in">varchar</span>(<span class="number">2</span>), <span class="string">'20'</span>), <span class="number">2</span> )</span><br><span class="line">  <span class="keyword">WHEN</span> e.ICMS_SAI = <span class="string">'F'</span> <span class="keyword">THEN</span> <span class="keyword">RIGHT</span>( <span class="string">'0'</span> + <span class="keyword">convert</span>(<span class="built_in">varchar</span>(<span class="number">2</span>), <span class="string">'60'</span>), <span class="number">2</span> )</span><br><span class="line">  <span class="keyword">WHEN</span> e.ICMS_SAI = <span class="string">'I'</span> <span class="keyword">THEN</span> <span class="keyword">RIGHT</span>( <span class="string">'0'</span> + <span class="keyword">convert</span>(<span class="built_in">varchar</span>(<span class="number">2</span>), <span class="string">'40'</span>), <span class="number">2</span> )</span><br><span class="line">  <span class="keyword">WHEN</span> e.ICMS_SAI = <span class="string">'N'</span> <span class="keyword">THEN</span> <span class="keyword">RIGHT</span>( <span class="string">'0'</span> + <span class="keyword">convert</span>(<span class="built_in">varchar</span>(<span class="number">2</span>), <span class="string">'41'</span>), <span class="number">2</span> )</span><br><span class="line">  <span class="keyword">END</span>) <span class="keyword">AS</span> CSTICMSSAIDA,</span><br><span class="line">  <span class="keyword">MAX</span>(a.VALOR) <span class="keyword">AS</span> ALIQICMSSAIDA, <span class="keyword">MAX</span>(a.ALIQ_FCP) <span class="keyword">AS</span> FCP_ALIQUOTA,</span><br><span class="line">  <span class="keyword">MAX</span>(<span class="keyword">CASE</span></span><br><span class="line">  <span class="keyword">WHEN</span> e.ICMS_SAI = <span class="string">'T'</span> <span class="keyword">AND</span> (a.REDUCAOBASECALCULO <span class="keyword">IS</span> <span class="literal">NULL</span> <span class="keyword">OR</span> a.REDUCAOBASECALCULO &lt;= <span class="number">0</span>) <span class="keyword">THEN</span> <span class="string">'102'</span></span><br><span class="line">  <span class="keyword">WHEN</span> e.ICMS_SAI = <span class="string">'T'</span> <span class="keyword">AND</span> a.REDUCAOBASECALCULO &gt; <span class="number">0</span> <span class="keyword">THEN</span> <span class="string">'102'</span></span><br><span class="line">  <span class="keyword">WHEN</span> e.ICMS_SAI = <span class="string">'F'</span> <span class="keyword">THEN</span> <span class="string">'500'</span></span><br><span class="line">  <span class="keyword">WHEN</span> e.ICMS_SAI = <span class="string">'I'</span> <span class="keyword">THEN</span> <span class="string">'300'</span></span><br><span class="line">  <span class="keyword">WHEN</span> e.ICMS_SAI = <span class="string">'N'</span> <span class="keyword">THEN</span> <span class="string">'400'</span></span><br><span class="line">  <span class="keyword">END</span>) <span class="keyword">AS</span> CSOSN</span><br><span class="line">  <span class="keyword">FROM</span> ESTOQUE e</span><br><span class="line">  <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> ESTCOD e1 <span class="keyword">ON</span> e.CODIGO = e1.CODIGO <span class="keyword">AND</span> e1.EAN <span class="keyword">NOT</span> <span class="keyword">LIKE</span> <span class="string">'F%'</span> <span class="keyword">AND</span> <span class="keyword">LEN</span>(e1.EAN) &gt; <span class="number">7</span></span><br><span class="line">  <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> PISCOF p <span class="keyword">ON</span> e.PISCOF = p.CODIGO</span><br><span class="line">  <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> ALIQUOTA a <span class="keyword">ON</span> e.ALIQUOTA = a.CODIGO</span><br><span class="line">  <span class="keyword">WHERE</span> e.SITUACAO = <span class="string">'A'</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> e.CODIGO;</span><br><span class="line"></span><br><span class="line">ELSE</span><br><span class="line"></span><br><span class="line"> <span class="keyword">SELECT</span> <span class="keyword">MAX</span>(e.CODIGO) <span class="keyword">AS</span> CODIGOINTERNO,<span class="keyword">MAX</span>(e.NOME) <span class="keyword">AS</span> DESCRICAO, <span class="keyword">MAX</span>(e1.EAN) <span class="keyword">AS</span> EAN, <span class="keyword">MAX</span>(e.CODNCM) <span class="keyword">AS</span> CODIGONCM, <span class="keyword">MAX</span>(e.CODCEST) <span class="keyword">AS</span> CODIGOCEST,</span><br><span class="line"> <span class="keyword">MAX</span>(p.SAIDA) <span class="keyword">AS</span> CSTPISSAIDA, <span class="keyword">MAX</span>(p.ALIQPIS) <span class="keyword">AS</span> ALIQPISSAIDA,<span class="keyword">MAX</span>(p.SAIDA) <span class="keyword">AS</span> CSTCOFINSSAIDA, <span class="keyword">MAX</span>(p.ALIQCOFINS) <span class="keyword">AS</span> ALIQCOFINSSAIDA,</span><br><span class="line"> <span class="keyword">MAX</span>(<span class="keyword">CASE</span></span><br><span class="line">  <span class="keyword">WHEN</span> e.ICMS_SAI = <span class="string">'T'</span> <span class="keyword">AND</span> (a.REDUCAOBASECALCULO <span class="keyword">IS</span> <span class="literal">NULL</span> <span class="keyword">OR</span> a.REDUCAOBASECALCULO &lt;= <span class="number">0</span>) <span class="keyword">THEN</span> <span class="keyword">RIGHT</span>( <span class="string">'0'</span> + <span class="keyword">convert</span>(<span class="built_in">varchar</span>(<span class="number">2</span>), <span class="string">'0'</span>), <span class="number">2</span> )</span><br><span class="line">  <span class="keyword">WHEN</span> e.ICMS_SAI = <span class="string">'T'</span> <span class="keyword">AND</span> a.REDUCAOBASECALCULO &gt; <span class="number">0</span> <span class="keyword">THEN</span> <span class="keyword">RIGHT</span>( <span class="string">'0'</span> + <span class="keyword">convert</span>(<span class="built_in">varchar</span>(<span class="number">2</span>), <span class="string">'20'</span>), <span class="number">2</span> )</span><br><span class="line">  <span class="keyword">WHEN</span> e.ICMS_SAI = <span class="string">'F'</span> <span class="keyword">THEN</span> <span class="keyword">RIGHT</span>( <span class="string">'0'</span> + <span class="keyword">convert</span>(<span class="built_in">varchar</span>(<span class="number">2</span>), <span class="string">'60'</span>), <span class="number">2</span> )</span><br><span class="line">  <span class="keyword">WHEN</span> e.ICMS_SAI = <span class="string">'I'</span> <span class="keyword">THEN</span> <span class="keyword">RIGHT</span>( <span class="string">'0'</span> + <span class="keyword">convert</span>(<span class="built_in">varchar</span>(<span class="number">2</span>), <span class="string">'40'</span>), <span class="number">2</span> )</span><br><span class="line">  <span class="keyword">WHEN</span> e.ICMS_SAI = <span class="string">'N'</span> <span class="keyword">THEN</span> <span class="keyword">RIGHT</span>( <span class="string">'0'</span> + <span class="keyword">convert</span>(<span class="built_in">varchar</span>(<span class="number">2</span>), <span class="string">'41'</span>), <span class="number">2</span> )</span><br><span class="line">  <span class="keyword">END</span>) <span class="keyword">AS</span> CSTICMSSAIDA,</span><br><span class="line">  <span class="keyword">MAX</span>(a.VALOR) <span class="keyword">AS</span> ALIQICMSSAIDA, <span class="keyword">MAX</span>(a.ALIQ_FCP) <span class="keyword">AS</span> FCP_ALIQUOTA,</span><br><span class="line">  <span class="keyword">MAX</span>(<span class="keyword">CASE</span></span><br><span class="line">  <span class="keyword">WHEN</span> e.ICMS_SAI = <span class="string">'T'</span> <span class="keyword">AND</span> (a.REDUCAOBASECALCULO <span class="keyword">IS</span> <span class="literal">NULL</span> <span class="keyword">OR</span> a.REDUCAOBASECALCULO &lt;= <span class="number">0</span>) <span class="keyword">THEN</span> <span class="string">'102'</span></span><br><span class="line">  <span class="keyword">WHEN</span> e.ICMS_SAI = <span class="string">'T'</span> <span class="keyword">AND</span> a.REDUCAOBASECALCULO &gt; <span class="number">0</span> <span class="keyword">THEN</span> <span class="string">'102'</span></span><br><span class="line">  <span class="keyword">WHEN</span> e.ICMS_SAI = <span class="string">'F'</span> <span class="keyword">THEN</span> <span class="string">'500'</span></span><br><span class="line">  <span class="keyword">WHEN</span> e.ICMS_SAI = <span class="string">'I'</span> <span class="keyword">THEN</span> <span class="string">'300'</span></span><br><span class="line">  <span class="keyword">WHEN</span> e.ICMS_SAI = <span class="string">'N'</span> <span class="keyword">THEN</span> <span class="string">'400'</span></span><br><span class="line">  <span class="keyword">END</span>) <span class="keyword">AS</span> CSOSN</span><br><span class="line">  <span class="keyword">FROM</span> ESTOQUE e</span><br><span class="line">  <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> ESTCOD e1 <span class="keyword">ON</span> e.CODIGO = e1.CODIGO <span class="keyword">AND</span> e1.EAN <span class="keyword">NOT</span> <span class="keyword">LIKE</span> <span class="string">'F%'</span> <span class="keyword">AND</span> <span class="keyword">LEN</span>(e1.EAN) &gt; <span class="number">7</span></span><br><span class="line">  <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> PISCOF p <span class="keyword">ON</span> e.PISCOF = p.CODIGO</span><br><span class="line">  <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> ALIQUOTA a <span class="keyword">ON</span> e.ALIQUOTA = a.CODIGO</span><br><span class="line">  <span class="keyword">WHERE</span> e.SITUACAO = <span class="string">'A'</span> <span class="keyword">AND</span>  e.FLAGSEMREVISAO &lt;&gt; <span class="string">'1'</span> <span class="keyword">AND</span> e.FLAGTRIBUT &lt;&gt; <span class="string">'T'</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> e.CODIGO;</span><br><span class="line"></span><br><span class="line">RETURN</span><br><span class="line">GO</span><br></pre></td></tr></table></figure>

<p>Esse exemplo demonstra o corpo inicial de uma procedure CORRETORFISCAL_PRODUTOS. Nele<br>pode ser visto os parâmetros de entrada e saída sendo aplicados. Fica a cargo da Sotware House<br>empregar a lógica de coleta dos parâmetros.</p>
<p>Recebendo dados corrigidos do acerto - <strong>CORRIGIR_TRIBUTACAO</strong></p>
<p>O Corretor fiscal fará uso da procedure descrita acima para enviar os dados para o banco de<br>dados do acerto que por sua vez retornará os dados tributários corrigidos. A procedure<br>encarregada de persistir os dados corrigidos pelo acerto no banco de dados do cliente é a<br><strong>CORRIGIR_TRIBUTACAO</strong>.</p>
<p>Assim como a <strong>CORRETORFISCAL_PRODUTOS</strong> a <strong>CORRIGIR_TRIBUTACAO</strong> também recebe dados de<br>entrada e saída.</p>
<p><strong>Parâmetros de entrada</strong></p>
<p>O corretor devolverá os dados tributários corrigidos referente a cada produto no banco do<br>cliente, são eles:</p>
<p><strong>IDCLIENTE</strong> - O ID de cadastro do cliente no Acerto Fiscal. Tipo:<br>ARCHAR(20)</p>
<p><strong>CODIGOPRODUTO</strong> - Código interno do produto, podendo ser a chave primária do mesmo ou<br>quaisquer outras colunas usadas como identificadores únicos com exceção do EAN. Tipo: VARCHAR(100)</p>
<p><strong>CODIGOEAN</strong> - Código EAN. Tipo: VARCHAR(14)</p>
<p><strong>NCM</strong> - Nomenclatura Comum do Mercosul. Tipo: VARCHAR(14)</p>
<p><strong>NCM_EX</strong> -</p>
<p><strong>CEST</strong> - Código Especificador da Substituição Tributária Corrigido Tipo: VARCHAR(10)</p>
<p><strong>CODIGOSEGMENTO</strong> - A tributação está organizada em segmentos dentro do banco do<br>acerto. Esse dado é retornado caso seja necessário criar algum tipo de distinção tributária<br>baseada em dados fornecidos pelo acerto. Tipo: INTEGER</p>
<p><strong>NOMESEGMENTO</strong> - Nome do segmento, veja atributo acima Tipo: VARCHAR(200)</p>
<p><strong>DESCRICAONCM</strong> - Descrição corrigida do NCM, pode ser usado para corrigir a tributação<br>existente do NCM. Tipo: VARCHAR(200)</p>
<p><strong>ICMS_ALIQUOTA</strong> - Alíquota de ICMS corrigida. Tipo: DOUBLE</p>
<p><strong>ICMS_CST</strong> - Código de Substituição Tributária do ICMS. Tipo: CHAR(2)</p>
<p><strong>ICMS_ORIGEM_CST</strong> - Código de Substituição Tributária de Origem do ICMS. Tipo: CHAR(3)</p>
<p><strong>ICMS_REDUCAOBASE</strong> - Redução base do ICMS. Tipo: DOUBLE</p>
<p><strong>CSOSN</strong> - Código de Situação da Operação do Simples Nacional corrigido. Tipo: INTEGER</p>
<p><strong>ORIGEM</strong> - Código de Origem. Tipo: CHAR(1)</p>
<p><strong>IPI_CST</strong> - Código de Substituição Tributária do IPI corrigido. Tipo: VARCHAR(2)</p>
<p><strong>IPI_ALIQUOTA</strong> - Alíquota IPI corrigida. Tipo: DOUBLE</p>
<p><strong>CFOP</strong> - Código Fiscal de Operações e Prestações. Tipo: CHAR(4)</p>
<p><strong>PIS_CST</strong> - Código de Substituição Tributária do PIS corrigido. Tipo: CHAR(2)</p>
<p><strong>PIS_ALIQUOTA</strong> - Alíquota do PIS corrigida. Tipo: DOUBLE</p>
<p><strong>COFINS_CST</strong> - Código de Substituição Tributária do COFINS corrigido. Tipo: CHAR(2)</p>
<p><strong>COFINS_ALIQUOTA</strong> - Alíquota COFINS corrigida. Tipo: DOUBLE</p>
<p><strong>NATUREZARECEITA</strong> - Natureza da receita. Tipo: VARCHAR(3)</p>
<p><strong>ICMS_SITUACAOTRIBUTARIA</strong> - ICMS de substituição tributária corrigido. Caso não precise ser<br>corrigido, pode ser definido como um varchar vazio Tipo: VARCHAR(50)</p>
<p><strong>FCP_ALIQUOTA</strong> - Alíquota do Fundo de combate a pobreza corrigida. Caso não precise ser<br>corrigido pode ser definido um valor padrão. Tipo: DOUBLE</p>
<p><strong>DESONERACAO</strong> - Campo informando se o produto tem desoneração ou não. Caso não exista<br>aceita valor padrão ‘F’. Tipo: CHAR(1)</p>
<p><strong>MOTIVODESONERACAO</strong> - Motivo da desoneração corrigido. Aceita campo padrão. Tipo: CHAR(1)</p>
<p><strong>ALIQUOTADESONERACAO</strong> - Alíquota desoneração corrigida. Aceita campo padrão. Tipo: CHAR(1)<br>CODIGOBENEFICIO - Código benefício corrigido.</p>
<p><strong>Parâmetros de retorno</strong></p>
<p>A procedure por sua vez retornará um status para o Acerto Fiscal para que o mesmo analise<br>dados sobre a correção. É encorajado o uso de transações e blocos try catch . Os campos de<br>retorno podem ser usados para fornecer informações úteis a cerca de possíveis erros de<br>execução ou informar o processamento correto da procedure</p>
<p><strong>STATUS</strong> - Um código de status definido pelos desenvolvedores da procedure, pode ser OK, 200,<br>500 de acordo com o tipo de retorno da procedure</p>
<p><strong>MENSAGEMERRO</strong> - Uma mensagem de erro ou de status</p>
<p>Obs.: No caso do campo STATUS o valor 0 (ZERO) significa que o produto foi corrigido, foi revisado.<br>Qualquer outro valor diferente de 0 (ZERO), significa o produto não foi corrigido.</p>
<p><strong>O que a procedure deve fazer ?</strong></p>
<p>A procedure <strong>CORRIGIR_TRIBUTACAO</strong> recebe os dados corrigidos do banco do Acerto Fiscal e se<br>encarrega de persisti-los no banco do cliente.</p>
<p>Também fica a cargo dessa procedure alimentar o campo FLAGTRIBUT com ‘T’ caso<br>a execução seja bem sucedida (veja o tópico O que a procedure deve fazer ? da procedure<br>CORRETORFISCAL_PRODUTOS). Dessa forma, o corretor terá a habilidade de enviar somente os<br>produtos pendentes de análise em seu fluxo de execução padrão.</p>
<p>Exemplo procedure CORRIGIR_TRIBUTACAO:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> dbo.CORRIGIR_TRIBUTACAO (</span><br><span class="line">					@IDCLIENTE <span class="built_in">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">					@CODIGOPRODUTO <span class="built_in">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">					@CODIGOEAN <span class="built_in">VARCHAR</span>(<span class="number">14</span>),</span><br><span class="line">					@NCM <span class="built_in">VARCHAR</span>(<span class="number">10</span>),</span><br><span class="line">					@NCM_EX <span class="built_in">VARCHAR</span>(<span class="number">10</span>),</span><br><span class="line">					@CEST <span class="built_in">VARCHAR</span>(<span class="number">10</span>),</span><br><span class="line">					@IDSEGMENTO <span class="built_in">INTEGER</span>,</span><br><span class="line">					@NOMESEGMENTO <span class="built_in">VARCHAR</span>(<span class="number">200</span>),</span><br><span class="line">					@DESCRICAONCM <span class="built_in">VARCHAR</span>(<span class="number">200</span>),</span><br><span class="line">					@ICMS_ALIQUOTA <span class="keyword">DOUBLE</span> <span class="keyword">PRECISION</span>,</span><br><span class="line">					@ICMS_CST <span class="built_in">CHAR</span>(<span class="number">2</span>),</span><br><span class="line">					@ICMS_ORIGEM_CST <span class="built_in">CHAR</span>(<span class="number">3</span>),</span><br><span class="line">					@ICMS_REDUCAOBASE <span class="keyword">DOUBLE</span> <span class="keyword">PRECISION</span>,</span><br><span class="line">					@CSOSN <span class="built_in">VARCHAR</span>(<span class="number">10</span>),</span><br><span class="line">					@ORIGEM <span class="built_in">CHAR</span>(<span class="number">1</span>),</span><br><span class="line">					@IPI_CST <span class="built_in">CHAR</span>(<span class="number">2</span>),</span><br><span class="line">					@IPI_ALIQUOTA <span class="keyword">DOUBLE</span> <span class="keyword">PRECISION</span>,</span><br><span class="line">					@CFOP <span class="built_in">CHAR</span>(<span class="number">4</span>),</span><br><span class="line">					@PIS_CST <span class="built_in">CHAR</span>(<span class="number">2</span>),</span><br><span class="line">					@PIS_ALIQUOTA <span class="keyword">DOUBLE</span> <span class="keyword">PRECISION</span>,</span><br><span class="line">					@COFINS_CST <span class="built_in">CHAR</span>(<span class="number">2</span>),</span><br><span class="line">					@COFINS_ALIQUOTA <span class="keyword">DOUBLE</span> <span class="keyword">PRECISION</span>,</span><br><span class="line">					@NATUREZARECEITA <span class="built_in">VARCHAR</span>(<span class="number">3</span>),</span><br><span class="line">					@ICMS_SITUACAOTRIBUTARIA <span class="built_in">VARCHAR</span>(<span class="number">50</span>) = <span class="string">''</span>,</span><br><span class="line">					@FCP_ALIQUOTA <span class="keyword">DOUBLE</span> <span class="keyword">PRECISION</span> = <span class="number">0</span>,</span><br><span class="line">					@DESONERACAO <span class="built_in">CHAR</span>(<span class="number">1</span>) = <span class="string">'F'</span>,</span><br><span class="line">					@MOTIVODESONERACAO <span class="built_in">CHAR</span>(<span class="number">1</span>) = <span class="string">'9'</span>,</span><br><span class="line">					@ALIQUOTADESONERACAO <span class="keyword">DOUBLE</span> <span class="keyword">PRECISION</span> = <span class="number">0</span>,</span><br><span class="line">					@CODIGOBENEFICIO <span class="built_in">VARCHAR</span>(<span class="number">10</span>) = <span class="string">''</span>,</span><br><span class="line">					@<span class="keyword">STATUS</span> <span class="built_in">INTEGER</span> <span class="keyword">OUTPUT</span>,</span><br><span class="line">					@MENSAGEMERRO <span class="built_in">VARCHAR</span>(<span class="number">400</span>) <span class="keyword">OUTPUT</span></span><br><span class="line"> ) <span class="keyword">AS</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">SET</span> NOCOUNT <span class="keyword">ON</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">DECLARE</span> @NOME_PROD <span class="built_in">VARCHAR</span>(<span class="number">40</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> @COD_ALIQUOTA <span class="built_in">NUMERIC</span>(<span class="number">4</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> @COD_ULTREG <span class="built_in">INT</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> @ICMS_SAI <span class="built_in">CHAR</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> @COD_PISCOF <span class="built_in">NUMERIC</span>(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> @MOTIVODESON <span class="built_in">INT</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- PEGA O NOME DO PRODUTO CADASTRADO NO BANCO DO CLIENTE</span></span><br><span class="line">    <span class="keyword">SET</span> @NOME_PROD = (<span class="keyword">SELECT</span> e.NOME <span class="keyword">FROM</span> ESTOQUE e <span class="keyword">WHERE</span> e.CODIGO = @CODIGOPRODUTO);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">SET</span> @COD_ALIQUOTA = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">SET</span> @COD_PISCOF = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">SET</span> @COD_ULTREG = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="comment">-- VERIFICAÇÃO DA ALIQUOTA - ICMS_SAI</span></span><br><span class="line">    IF NOT EXISTS ( <span class="keyword">SELECT</span> TOP <span class="number">1</span> a.CODIGO <span class="keyword">FROM</span> ALIQUOTA a <span class="keyword">WHERE</span> valor = @ICMS_ALIQUOTA <span class="keyword">AND</span> a.ALIQ_FCP = @FCP_ALIQUOTA <span class="keyword">AND</span> a.REDUCAOBASECALCULO = @ICMS_REDUCAOBASE )</span><br><span class="line"></span><br><span class="line">      <span class="keyword">BEGIN</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">--select no ultreg campo tabela = 'aliquota' -&gt; codigo</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>  (<span class="keyword">SELECT</span> u.CODIGO <span class="keyword">FROM</span> ULTREG u <span class="keyword">WHERE</span> u.TABELA = <span class="string">'ALIQUOTA'</span>)</span><br><span class="line">          <span class="keyword">BEGIN</span></span><br><span class="line">            <span class="keyword">SET</span> @COD_ULTREG = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">INSERT</span> <span class="keyword">INTO</span> ULTREG (TABELA,CODIGO) <span class="keyword">VALUES</span> (<span class="string">'ALIQUOTA'</span>,@COD_ULTREG);</span><br><span class="line">          <span class="keyword">END</span></span><br><span class="line">        <span class="keyword">ELSE</span></span><br><span class="line">          <span class="keyword">BEGIN</span></span><br><span class="line">            <span class="keyword">SET</span> @COD_ULTREG = (<span class="keyword">SELECT</span> u.CODIGO <span class="keyword">FROM</span> ULTREG u <span class="keyword">WHERE</span> u.TABELA = <span class="string">'ALIQUOTA'</span>);</span><br><span class="line">          <span class="keyword">END</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">-- insert em aliquota</span></span><br><span class="line">         <span class="keyword">SET</span> @COD_ALIQUOTA = @COD_ULTREG;</span><br><span class="line">         <span class="keyword">INSERT</span> <span class="keyword">INTO</span> ALIQUOTA (CODIGO,VALOR,ESTADO,ALIQ_FCP,REDUCAOBASECALCULO) <span class="keyword">VALUES</span> (@COD_ALIQUOTA,@ICMS_ALIQUOTA,<span class="string">'RJ'</span>,@FCP_ALIQUOTA,@ICMS_REDUCAOBASE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">--update no ultreg</span></span><br><span class="line">        <span class="keyword">UPDATE</span> ULTREG <span class="keyword">SET</span> CODIGO = @COD_ULTREG + <span class="number">1</span> <span class="keyword">WHERE</span> TABELA = <span class="string">'ALIQUOTA'</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">END</span></span><br><span class="line">    <span class="keyword">ELSE</span></span><br><span class="line">      <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">SET</span> @COD_ALIQUOTA =  ( <span class="keyword">SELECT</span> TOP <span class="number">1</span> a.CODIGO <span class="keyword">FROM</span> ALIQUOTA a <span class="keyword">WHERE</span> valor = @ICMS_ALIQUOTA <span class="keyword">AND</span> a.ALIQ_FCP = @FCP_ALIQUOTA <span class="keyword">AND</span> a.REDUCAOBASECALCULO = @ICMS_REDUCAOBASE );</span><br><span class="line">      <span class="keyword">END</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- VERIFICAÇÃO DO PISCOF_SAIDA</span></span><br><span class="line">    <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>  (<span class="keyword">SELECT</span> TOP <span class="number">1</span> p.CODIGO <span class="keyword">FROM</span> PISCOF p <span class="keyword">WHERE</span> p.SAIDA = @PIS_CST <span class="keyword">AND</span>  p.ALIQPIS = @PIS_ALIQUOTA <span class="keyword">AND</span> p.ALIQCOFINS = @COFINS_ALIQUOTA )</span><br><span class="line"></span><br><span class="line">      <span class="keyword">BEGIN</span></span><br><span class="line">    	  <span class="comment">--select no ultreg campo tabela = 'PISCOF' -&gt; codigo</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> u.CODIGO <span class="keyword">FROM</span> ULTREG u <span class="keyword">WHERE</span> u.TABELA = <span class="string">'PISCOF'</span>)</span><br><span class="line">          <span class="keyword">BEGIN</span></span><br><span class="line">            <span class="keyword">SET</span> @COD_ULTREG = @COD_ULTREG + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">INSERT</span> <span class="keyword">INTO</span> ULTREG (TABELA,CODIGO) <span class="keyword">VALUES</span> (<span class="string">'PISCOF'</span>,@COD_ULTREG);</span><br><span class="line">          <span class="keyword">END</span></span><br><span class="line">        <span class="keyword">ELSE</span></span><br><span class="line">          <span class="keyword">BEGIN</span></span><br><span class="line">            <span class="keyword">SET</span> @COD_ULTREG = (<span class="keyword">SELECT</span> u.CODIGO <span class="keyword">FROM</span> ULTREG u <span class="keyword">WHERE</span> u.TABELA = <span class="string">'PISCOF'</span>);</span><br><span class="line">          <span class="keyword">END</span></span><br><span class="line"></span><br><span class="line">           <span class="comment">-- insert em piscof</span></span><br><span class="line">          <span class="keyword">INSERT</span> <span class="keyword">INTO</span> PISCOF (CODIGO,DESCRICAO,ENTRADA,SAIDA,ALIQPIS,ALIQCOFINS,NAT_REC) <span class="keyword">VALUES</span> (@COD_ULTREG,<span class="string">'OUTROS'</span>,<span class="string">'00'</span>,@PIS_CST,@PIS_ALIQUOTA,@COFINS_ALIQUOTA,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">           <span class="comment">--update em estoque, campo PISCOF</span></span><br><span class="line">          <span class="keyword">UPDATE</span> ESTOQUE <span class="keyword">SET</span> PISCOF = @COD_ULTREG <span class="keyword">WHERE</span> CODIGO = @CODIGOPRODUTO;</span><br><span class="line"></span><br><span class="line">          <span class="comment">--update no ultreg</span></span><br><span class="line">          <span class="keyword">SET</span> @COD_ULTREG = @COD_ULTREG + <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">UPDATE</span> ULTREG <span class="keyword">SET</span> CODIGO = @COD_ULTREG <span class="keyword">WHERE</span> TABELA = <span class="string">'PISCOF'</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">END</span></span><br><span class="line">    <span class="keyword">ELSE</span></span><br><span class="line">      <span class="keyword">BEGIN</span></span><br><span class="line">          <span class="keyword">SET</span> @COD_PISCOF = (<span class="keyword">SELECT</span> TOP <span class="number">1</span> p.CODIGO <span class="keyword">FROM</span> PISCOF p <span class="keyword">WHERE</span> p.SAIDA = @PIS_CST <span class="keyword">AND</span>  p.ALIQPIS = @PIS_ALIQUOTA <span class="keyword">AND</span> p.ALIQCOFINS = @COFINS_ALIQUOTA );</span><br><span class="line">          <span class="keyword">UPDATE</span> ESTOQUE <span class="keyword">SET</span> PISCOF = @COD_PISCOF <span class="keyword">WHERE</span> CODIGO = @CODIGOPRODUTO;</span><br><span class="line">      <span class="keyword">END</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">-- se @ICMS_CST - 00,20 = T  10,30,60,70 =&gt; 'F' 40 -&gt; I 41 -&gt; N</span></span><br><span class="line">    <span class="keyword">SET</span> @ICMS_SAI = <span class="keyword">CASE</span></span><br><span class="line">      <span class="keyword">WHEN</span> @ICMS_CST <span class="keyword">IN</span> (<span class="string">'00'</span>,<span class="string">'20'</span>) <span class="keyword">THEN</span> <span class="string">'T'</span></span><br><span class="line">      <span class="keyword">WHEN</span> @ICMS_CST <span class="keyword">IN</span> (<span class="string">'10'</span>,<span class="string">'30'</span>,<span class="string">'60'</span>,<span class="string">'70'</span>) <span class="keyword">THEN</span> <span class="string">'F'</span></span><br><span class="line">      <span class="keyword">WHEN</span> @ICMS_CST <span class="keyword">IN</span> (<span class="string">'40'</span>) <span class="keyword">THEN</span> <span class="string">'I'</span></span><br><span class="line">      <span class="keyword">WHEN</span> @ICMS_CST <span class="keyword">IN</span> (<span class="string">'41'</span>) <span class="keyword">THEN</span> <span class="string">'N'</span></span><br><span class="line">      <span class="keyword">END</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">IF</span> @MOTIVODESONERACAO = <span class="string">''</span> <span class="keyword">OR</span> @MOTIVODESONERACAO <span class="keyword">IS</span> <span class="literal">NULL</span></span><br><span class="line">      <span class="keyword">BEGIN</span></span><br><span class="line">    	  <span class="keyword">SET</span> @MOTIVODESON = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">END</span></span><br><span class="line">    <span class="keyword">ELSE</span></span><br><span class="line">      <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">SET</span> @MOTIVODESON = <span class="keyword">CONVERT</span>(<span class="built_in">INT</span>, @MOTIVODESONERACAO);</span><br><span class="line">      <span class="keyword">END</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">BEGIN</span> TRY</span><br><span class="line">      <span class="keyword">UPDATE</span> ESTOQUE <span class="keyword">SET</span></span><br><span class="line">      ALIQUOTA = <span class="keyword">CASE</span> <span class="keyword">WHEN</span> @ICMS_SAI = <span class="string">'I'</span> <span class="keyword">THEN</span> @ALIQUOTADESONERACAO <span class="keyword">ELSE</span> @COD_ALIQUOTA <span class="keyword">END</span>,</span><br><span class="line">      CODNCM = <span class="keyword">LEFT</span>(@NCM,<span class="number">8</span>), ICMS_SAI = @ICMS_SAI, MOTIVODESON = @MOTIVODESON, PISCOF = @COD_PISCOF,</span><br><span class="line">      NATRECPISCOF = <span class="keyword">CONVERT</span>(<span class="built_in">INT</span>,@NATUREZARECEITA), CODCEST = <span class="keyword">LEFT</span>(@CEST,<span class="number">7</span>), CODBENEFICIO =	@CODIGOBENEFICIO,</span><br><span class="line">      FLAGTRIBUT = <span class="string">'T'</span>, DTTRIBUT = <span class="keyword">GETDATE</span>() <span class="keyword">WHERE</span> CODIGO = @CODIGOPRODUTO;</span><br><span class="line">    <span class="keyword">END</span> TRY</span><br><span class="line">      <span class="keyword">BEGIN</span> CATCH</span><br><span class="line">	<span class="keyword">SET</span> @<span class="keyword">STATUS</span> = <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">SET</span> @MENSAGEMERRO = ERROR_MESSAGE() + ERROR_LINE();</span><br><span class="line">	RETURN;</span><br><span class="line">     <span class="keyword">END</span> CATCH;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">SET</span> @<span class="keyword">STATUS</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">SET</span> @MENSAGEMERRO = <span class="string">'REVISADO - OK'</span>;</span><br><span class="line"></span><br><span class="line">    RETURN;</span><br><span class="line">  <span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">GO</span></span><br></pre></td></tr></table></figure>

<p>Esse exemplo demonstra o corpo inicial de uma procedure CORRIGIR_TRIBUTACAO. Nele pode<br>ser visto os parâmetros de entrada e saída sendo aplicados. Fica a cargo da Sotware House<br>persistir os dados, tal como a utilização de boas práticas no desenvolvimento da mesma.</p>
<p><strong>Trigger TRG_TributosEstoque_AU</strong></p>
<p>A trigger TRG_TributosEstoque_AU é uma customização específica da empresa Tetra Soluções.<br>O objetivo da trigger TRG_TributosEstoque_AU é verificar se alguns campos da tabela ESTOQUE<br>sofreram alguma alteração.</p>
<p>Exemplo dos campos que podem sofrer alteração no cadastro de produto. Tabela ESTOQUE:</p>
<ul>
<li>ALIQUOTA</li>
<li>CODNCM</li>
<li>ICMS_SAI</li>
<li>MOTIVODESON</li>
<li>PISCOF</li>
<li>NATRECPISCOF</li>
<li>CODCEST</li>
<li>CODBENEFICIO</li>
</ul>
<p>Caso um desses campos sofram alguma alteração, a trigger irá marcar os campos FLAGTRIBUT = ‘F’,<br>DTTRIBUT = null de acordo com o código do produto. Isso significa que o produto em questão está<br>sendo marcado para ser revisado na próxima correção.</p>
<p>Obs.: Caso o campo FLAGSEMREVISAO esteja com valor igual a ‘1’, significa que esse produto não será<br>revisado em momento algum, ou seja, nunca será revisado.</p>
<h3 id="Exemplo-trigger-TRG-TributosEstoque-AU"><a href="#Exemplo-trigger-TRG-TributosEstoque-AU" class="headerlink" title="Exemplo trigger TRG_TributosEstoque_AU:"></a>Exemplo trigger TRG_TributosEstoque_AU:</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> dbo.TRG_TributosEstoque_AU</span><br><span class="line"><span class="keyword">ON</span> ESTOQUE <span class="keyword">AFTER</span> <span class="keyword">UPDATE</span></span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">SET</span> NOCOUNT <span class="keyword">ON</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">DECLARE</span> @COD_PROD <span class="built_in">NUMERIC</span>(<span class="number">6</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">DECLARE</span> @AUX_FLAGTIRBUT <span class="built_in">CHAR</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">SELECT</span> @COD_PROD = ins.CODIGO <span class="keyword">FROM</span> INSERTED ins;</span><br><span class="line">  <span class="keyword">SELECT</span> @AUX_FLAGTIRBUT = ins.FLAGTRIBUT <span class="keyword">FROM</span> INSERTED ins;</span><br><span class="line"></span><br><span class="line">  IF ((<span class="keyword">UPDATE</span>(ALIQUOTA) <span class="keyword">OR</span> <span class="keyword">UPDATE</span>(CODNCM) <span class="keyword">OR</span> <span class="keyword">UPDATE</span>(ICMS_SAI) <span class="keyword">OR</span> <span class="keyword">UPDATE</span>(MOTIVODESON) <span class="keyword">OR</span> <span class="keyword">UPDATE</span>(PISCOF)</span><br><span class="line">    <span class="keyword">OR</span> <span class="keyword">UPDATE</span>(NATRECPISCOF) <span class="keyword">OR</span> <span class="keyword">UPDATE</span>(CODCEST) <span class="keyword">OR</span> <span class="keyword">UPDATE</span>(CODBENEFICIO)) <span class="keyword">AND</span> (@AUX_FLAGTIRBUT &lt;&gt; <span class="string">'T'</span>))</span><br><span class="line">  <span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">UPDATE</span> ESTOQUE <span class="keyword">SET</span> FLAGTRIBUT = <span class="string">'F'</span>, DTTRIBUT = <span class="literal">NULL</span> <span class="keyword">WHERE</span> CODIGO = @COD_PROD;</span><br><span class="line">  <span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span></span><br><span class="line"><span class="keyword">GO</span></span><br></pre></td></tr></table></figure>

<h1 id="Informacoes-para-IMPLANTACAO-E-SUPORTE-EQUIPE-TETRA"><a href="#Informacoes-para-IMPLANTACAO-E-SUPORTE-EQUIPE-TETRA" class="headerlink" title="Informações para IMPLANTAÇÃO E SUPORTE. EQUIPE TETRA"></a>Informações para IMPLANTAÇÃO E SUPORTE. EQUIPE TETRA</h1><p>O procedimento de instalação consiste nesses passos:</p>
<ol>
<li>Criar os procedimentos no cliente:<ol>
<li>procedure <strong>CORRETORFISCAL_PRODUTOS</strong> - essa procedure pega os produtos ATIVOS com o campo <em>flagtribut</em> &lt;&gt; ‘T’ e que não esteja marcados como <em>sem revisão</em> no seu cadastro. Enviam para análise do ACERTO FISCAL;</li>
<li>procedure <strong>CORRIGIR_TRIBUTACAO</strong> - esta procedure é consumida pelo integrador do ACERTO FISCAL para atualizar os produtos revisados.</li>
<li>trigger <strong>TRG_TributosEstoque_AU</strong> - coloca o produto para ser revisado sempre que algum campo de tributação for alterado pelo usuário.</li>
</ol>
</li>
<li>Informar ao CLIENTE e a equipe do ACERTO FISCAL que o banco de dados está pronto para ser integrado.</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sincronos.github.io/2021/03/31/Acerto/" data-id="ckmy19y7m00010xi06t9ixtzj" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/fiscal/">fiscal</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2021/03/31/GestaoSoftware/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Gestao de Software - Tetra</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AlertaFiscal/">AlertaFiscal</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Comanda/">Comanda</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tetra-ComoTributar-ServicoTetra/">Tetra;ComoTributar;ServicoTetra</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TetraSonar/">TetraSonar</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fiscal/">fiscal</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AlertaFiscal/" style="font-size: 10px;">AlertaFiscal</a> <a href="/tags/Comanda/" style="font-size: 10px;">Comanda</a> <a href="/tags/Tetra-ComoTributar-ServicoTetra/" style="font-size: 10px;">Tetra;ComoTributar;ServicoTetra</a> <a href="/tags/TetraSonar/" style="font-size: 10px;">TetraSonar</a> <a href="/tags/fiscal/" style="font-size: 10px;">fiscal</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/03/31/Acerto/">Acerto Fiscal - Integração</a>
          </li>
        
          <li>
            <a href="/2021/03/31/GestaoSoftware/">Gestao de Software - Tetra</a>
          </li>
        
          <li>
            <a href="/2021/02/24/Audittar/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/02/19/Scantech/">SCANTECH</a>
          </li>
        
          <li>
            <a href="/2020/11/03/Clubiz/">CLUBIZ</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Carlos Viana<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>